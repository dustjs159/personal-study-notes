💻 [AWS] EC2 Spot Instance
==============================

* 온디맨드보다 최대 90% 저렴하게 인스턴스를 사용할 수 있는 방법 - 스팟 인스턴스
* 스팟 인스턴스 : 사용자가 인스턴스 사용에 대해 가격을 지정하고 지정한 가격이 현재 시세보다 낮아지면 인스턴스를 중지 혹은 종료하는 방식.
  * 지정한 가격(Max Spot Price) > 현재 시세(Current Spot Price) : 인스턴스 정상 가동
  * 지정한 가격(Max Spot Price) < 현재 시세(Current Spot Price) : **2분 내** 인스턴스 중지 or 종료
    * 인스턴스를 중지할지, 종료할지는 선택
* 스팟 인스턴스는 AZ 단위로 적용됨. 

## 스팟 인스턴스의 개념
* 스팟 용량 풀(Pool)
* 스팟 비용(Price)
* 스팟 요청(Request) : 스팟 인스턴스 적용을 위한 사용자의 요청
  * 요청 유효 기간
  * 인스턴스를 시작할 때 필요한 설정 값들(AMI, 키페어, SG, VPC/서브넷 등)
  * 인스턴스 유형
    * 사전에 정의된 인스턴스 유형(t3.small 처럼)을 선택할 수도 있고 직접 인스턴스의 min/max vCPU 개수, Memory를 정의할 수도 있다.
  * 인스턴스의 수
  * 사용자 정의 가격
  * 요청 유형
    * 일회성 요청
    * 지속적 요청

스팟 요청과 비용을 포함하여 적절한 스팟 풀을 선택하고 해당 풀에서 스팟 인스턴스를 실행하게 된다.

## 스팟 인스턴스 요청 유형에 따른 동작 원리
<img width="533" alt="스크린샷 2023-06-06 오전 11 12 38" src="https://github.com/dustjs159/Study/assets/57285121/85e2d76e-26a1-4583-8750-f86e6ef4ba1e">
(여기서 Interrupt는 스팟 가격 상승 혹은 사용자의 스팟 요청 중지 등을 의미)

* 일회성 요청 : 사용자가 스팟 요청을 중지하거나 가격 변동 등의 이유로 인스턴스가 회수된 이후 스팟 재요청을 안함.
  * 인스턴스가 정상적으로 실행된 이후에 스팟 요청이 바로 소멸됨
* 지속적 요청 : 사용자가 스팟 요청을 중지하거나 가격 변동 등의 이유로 인스턴스가 회수된 이후에도 지속적으로 스팟 재요청.
  * 유효기간 내 스팟 요청이 계속 존재하고 유효기간이 만료되면 인스턴스가 종료됨(default)

## 스팟 인스턴스 Lifecycle 정의
<img width="348" alt="스크린샷 2023-06-06 오전 11 22 46" src="https://github.com/dustjs159/Study/assets/57285121/4dcab84c-fefe-4a7a-ab6b-2957fa59f18d">

* `open` : 요청 대기중
* `active` : 요청이 정상적으로 수행되어 스팟 인스턴스 실행중
* `failed` : 요청에 잘못된 파라메터가 있음
* `closed` : 스팟 인스턴스 중지/종료
  * (사용자의 요청에 의한 중지가 아님)
* `disabled` : 사용자가 스팟 요청 중지함
  * (사용자의 요청에 의한 중지임)
* `cancelled` : 사용자의 스팟 요청이 중지/취소 혹은 만료된 상태 

## Spot Fleet & 할당 전략
* Spot Fleet : 스팟 인스턴스의 집합
  * 온디맨드 인스턴스도 집합에 포함시킬 수 있음(선택)
* Spot Fleet 내 스팟 인스턴스 할당 전략 : 스팟 Pool을 정의(인스턴스 유형, AMI, AZ 등)하고 Fleet 내에서 인스턴스를 생성할 때의 "기준". 선택한 기준에 따라 스팟 인스턴스 요청을 자동화 할 수 있음
  * 가격/사용량 최적화 (추천) : 선택한 스팟 풀 중에서 가장 저렴한 가격으로 스팟 요청

스팟 인스턴스는 언제든 회수될 수 있기에 장기적으로 운영되어야 하는 인스턴스에는 적절하지 못하지만 배치 작업같이 특정 시간대에만 필요한 경우에 고려해볼 수 있겠다.